library(RSeqLib)
library(testthat)

ref = "TGCTCTGGCACAAAGATAGGCATGCTCAGCCCACCTCTGCCAGCACTGGGGCTGAAGACTGGCCCACGTGTCCTCTCAATCCCCAGGACAACTTCACTATGGCTTTCATTAATAACCACACTCTAATCCATGAAGGAAATCACAGATGCTACTAACACTGTTTACAGCCAAAGAAATCATATGGAGACTACACTACTGGATGCACCCAGAATCAAAGCCAAAGTGCTCTACCCAACTGATACCAGAGATACATCTTCAGGAAAAAGTCCTCCCCTATAAAAGCAAATTCAAAAATAGAAGGTGACTATTATGCCAGATGCACAGATATCAACATAAGGACACAGAAAGCAGGAAAAGCAAGGAAATATGACTCCTTCAAAGGAACACAATAATTTTTCAGCATTAGATCTTAATCAGAAAGAACTTACATAACATCCCAGATAAATAATTCAAAATAATGATTTTAAAGAAACTCAGTAAAATACAAGAAAATTCTGAAAAACAATAGAAAGAAATTAGAAAATCAATTCAGAATATAAATGAGAAATTTACACAGAAATAGACATTTTTAAATGAACCAAATAGAAATTCTGGAACTGAAGAATTCATTGAAGGAAATAAAAAAAACACATTTGAAAGCATCAACAATAGATTAGATCAGGTAGAATAAAGAATCTCAGAACTTGAAGACAGATCTTTTTAAATACTCCAATCAGACAATTAAAAAAAAAA"

qstring = c("TGCTCTGGCACAAAGATAGGCATGCTCAGCCCACCTCTGCCAGCACTGGGGCTGAAGACTGGCCCACGTGTCCTCTCAATCCCCAGGACAACTTCACTATGGCTTTCATTAATAA",
             "GCACAGATATCAACATAAGGACACAGAAAGCAGGAAAAGCAAGGAAATATGACTCCTTCAAAGGAACACAATAATTTTTCAGCATTAGATCTTAATCAGAAAGAACTTACTCCCAGATAAATAATTCAAAATAA")

test_that("BWA", {
  bwa = BWA(seq = ref) ## test index creationg from seq
  gr = bwa[qstring]
  expect_equal(gr$cigar, c('115M', '110M6D24M'))
  expect_equal(start(gr), c(0, 318))
  expect_equal(end(gr), c(114, 457))

  bwa = BWA(seq = c(
              allele1 = "CACTAGCTAGCTACGCGGGGGCGCGCGCGCGCGAAAAACACTTTCACAG",
              allele2 = "CACTAGCTAGCTACGCGGGGGCGCGCGCGCGCGAAAAACACTTTCACAG"))

  gr = bwa[c("CACTAGCTAGCTACGCGGGGGCGCG", "CACTAGCTAGCTACGCGCGAAAAACACTTTCACAG")]
  expect_equal(gr$cigar, c('25M', '25M', '13S22M', '13S22M'))
  expect_equal(start(gr), c(0, 0, 27, 27))
  expect_equal(end(gr), c(24, 24, 48, 48))
})


test_that("BWA fasta", { ## test index loading from fasta
  bwa = BWA(system.file('ext/mini.genome.fasta', package = 'RSeqLib'))
  gr = bwa[qstring]
  expect_identical(gr$cigar, c('115M', '24M6D110M'))
  expect_equal(start(gr), c(108294, 107951))
  expect_equal(end(gr), c(108408, 108090))
})

test_that("Fermi", {
  reads = readRDS(system.file('ext/reads.rds', package = 'RSeqLib'))
  fermi = Fermi(reads, assemble = TRUE, correct = FALSE)
  expect_equal(contigs(fermi)[5],
               "TGATATTAATTCTCCTGATCCCTGAACATGGGATGTTTTTCCATTTGTTTGTCCCATCTTCAATTTATTTCATTCATGTTGCCTAGTTTTTTTTTTTTTTTGGTGGTTAAATTTATTCCTAGGTATTTTTTTGTAGTTATTGTAAATGGGATTGCCTTCTTAACCTCTTTCTTGCCTGGATCACT")
  expect_equal(contigs(fermi)[12],
               "AAATAATAGATAAAACTGTCCAAGTCGAGCAACAGATTTAGATATTCAGAAGCAGGAGGCTTAGCGATCCCCAGGAAGATAAGTGCAAAAAGGTCTTCTCTGTGGCACATTATGTTCAGACAATCTAACATCAAACATAAAGAGTGAATCCTAAAAACAGGAAGATAAAGACATCTAGTCACCTATAACGGAAACCTCATC")

  bwa = BWA(system.file('ext/mini.genome.fasta', package = 'RSeqLib'))
  gr = bwa[contigs(fermi)]
  expect_equal(gr$cigar, c('732M', '3147M', '198M', '892M', '86M1I98M', '780M', '1689M', '205M', '248M', '725M', '200M', '201M', '360M', '192M', '201M', '185M', '192M', '71M2D93M', '295M', '352M', '194M', '188M', '290M', '199M', '198M', '142M', '166M', '246M', '195M', '191M', '203M', '79M1D91M', '198M', '198M', '200M', '143M', '186M', '202M', '88M1D94M', '204M', '199M', '176M', '185M'))
  expect_equal(start(gr), c(107677, 100840, 104661, 105515, 103890, 103979, 108411, 105158, 105265, 106413, 105015, 107039, 100191, 100097, 107039, 100455, 105019, 100623, 107140, 104762, 100094, 105422, 99899, 100740, 104662, 100696, 100542, 107439, 105415, 107586, 106310, 100460, 108310, 107338, 107337, 105115, 100741, 106311, 107588, 105161, 108310, 103895, 100609))
  expect_equal(end(gr), c(108408, 103986, 104858, 106406, 104073, 104758, 110099, 105362, 105512, 107137, 105214, 107239, 100550, 100288, 107239, 100639, 105210, 100788, 107434, 105113, 100287, 105609, 100188, 100938, 104859, 100837, 100707, 107684, 105609, 107776, 106512, 100630, 108507, 107535, 107536, 105257, 100926, 106512, 107770, 105364, 108508, 104070, 100793))
})



